<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Admin – Manage Products</title>

<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">

<style>
:root { --bg:#FAF0DE; --accent:#563e30; --text:#563e30; }

body {
    margin:0;
    font-family:system-ui;
    background:var(--bg);
    padding:16px;
}

.container {
    max-width:900px;
    margin:0 auto;
    background:#fff;
    padding:20px;
    border-radius:12px;
    box-shadow:0 8px 24px rgba(0,0,0,0.08);
}

.header {
    display:flex;
    align-items:center;
    justify-content:space-between;
}

.logo {
    height:60px;
    border-radius:8px;
}

.nav-btn {
    background:var(--accent);
    color:#fff;
    padding:8px 14px;
    border-radius:7px;
    text-decoration:none;
    margin-left:10px;
    font-weight:600;
}

h2 {
    text-align:center;
    color:var(--text);
    font-family:'Great Vibes', cursive;
    font-size:38px;
    margin-top:10px;
}

form {
    background:#fff7ee;
    padding:16px;
    border-radius:10px;
    margin-top:20px;
}

input, textarea {
    width:100%;
    padding:10px;
    margin-top:8px;
    border-radius:6px;
    border:1px solid #ccc;
}

button {
    background:var(--accent);
    color:white;
    border:none;
    padding:10px 18px;
    margin-top:12px;
    border-radius:8px;
    cursor:pointer;
    font-size:15px;
}

#prodPreview {
    width:140px;
    height:140px;
    object-fit:cover;
    border-radius:10px;
    margin-top:10px;
    display:none;
}

.product-list {
    margin-top:20px;
}

.product-item {
    background:#fff7ef;
    padding:14px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    border-radius:10px;
    margin-bottom:10px;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.product-item img {
    height:70px;
    width:70px;
    border-radius:8px;
    object-fit:cover;
}

.delete-btn {
    background:#d9534f;
    padding:6px 10px;
    color:#fff;
    border:none;
    border-radius:6px;
    cursor:pointer;
}

#diskBox {
    background:#fff7ef;
    padding:12px;
    border-radius:10px;
    margin-top:15px;
}

</style>
</head>
<body>

<div class="container">

    <div class="header">
        <img src="/logo/dorys.PNG" class="logo">

        <div>
            <a class="nav-btn" href="/">Home</a>
            <a class="nav-btn" href="/upload.html">Upload Images</a>
            <a class="nav-btn" href="#" onclick="logout()">Logout</a>
        </div>
    </div>

    <h2>Manage Products</h2>

    <!-- Disk Usage -->
    <div id="diskBox">
        <div style="font-weight:700">Disk Usage</div>
        <div style="height:10px;background:#eee;border-radius:8px;overflow:hidden;margin-top:6px;">
            <div id="diskFill" style="height:100%;width:0%;background:var(--accent)"></div>
        </div>
        <div id="diskText" style="font-size:13px;color:#666;margin-top:6px;">Loading...</div>
    </div>

    <!-- Add Product Form -->
    <form id="prodForm">
        <label>Product Name</label>
        <input type="text" id="prodName" required>

        <label>Description</label>
        <textarea id="prodDesc" rows="3"></textarea>

        <label>Price</label>
        <input type="text" id="prodPrice">

        <label>Image</label>
        <input type="file" id="prodImage" accept="image/*">
        <img id="prodPreview">

        <button type="submit">Add Product</button>
        <div id="status" style="margin-top:10px;color:#444;"></div>
    </form>

    <!-- Product List -->
    <div class="product-list" id="productList">Loading products...</div>

</div>

<script>

/* --------------------------------------
   ADMIN PIN
----------------------------------------*/
function readCookie(name){
    const v=document.cookie.split(";").map(x=>x.trim()).find(x=>x.startsWith(name+"="));
    return v?decodeURIComponent(v.split("=")[1]):null;
}
function setCookie(n,v){ document.cookie=`${n}=${v}; path=/;`; }
function deleteCookie(n){ document.cookie=`${n}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`; }

if(readCookie("admin")!=="4321"){
    const pin=prompt("Enter Admin PIN:");
    if(pin!=="4321"){ alert("Wrong PIN"); location.href="/"; }
    setCookie("admin","4321");
}

function logout(){
    deleteCookie("admin");
    location.href="/";
}

/* --------------------------------------
   PRODUCT IMAGE PREVIEW + HEIC SUPPORT
----------------------------------------*/
const prodImage = document.getElementById("prodImage");
const prodPreview = document.getElementById("prodPreview");
let finalUploadFile = null;

function isHeic(f){
    return /\.heic$|\.heif$/i.test(f.name);
}

prodImage.addEventListener("change", async () => {
    const file = prodImage.files[0];
    if (!file) return;

    // Show preview
    prodPreview.src = URL.createObjectURL(file);
    prodPreview.style.display = "block";

    // HEIC → JPG conversion
    if (isHeic(file)) {
        const converted = await heic2any({
            blob: file,
            toType: "image/jpeg",
            quality: 0.92
        });
        finalUploadFile = new File([converted], "converted.jpg", { type: "image/jpeg" });
    } else {
        finalUploadFile = file;
    }
});

/* --------------------------------------
   ADD PRODUCT (POST /products/add)
----------------------------------------*/
const form = document.getElementById("prodForm");
const status = document.getElementById("status");

form.addEventListener("submit", async (e)=>{
    e.preventDefault();
    status.textContent = "Uploading...";

    const fd = new FormData();
    fd.append("name", document.getElementById("prodName").value);
    fd.append("description", document.getElementById("prodDesc").value);
    fd.append("price", document.getElementById("prodPrice").value);

    if(finalUploadFile){
        fd.append("image", finalUploadFile);
    }

    const res = await fetch("/products/add", {
        method:"POST",
        body:fd,
        credentials:"include"
    });

    const j = await res.json();
    if(res.ok){
        status.textContent = "Product added!";
        form.reset();
        prodPreview.style.display="none";
        finalUploadFile = null;
        loadProducts();
        loadDisk();
    } else {
        status.textContent = "Error: " + (j.error || "Failed");
    }
});

/* --------------------------------------
   LOAD PRODUCTS
----------------------------------------*/
async function loadProducts(){
    const box = document.getElementById("productList");
    box.innerHTML = "Loading...";

    const res = await fetch("/products/list");
    const list = await res.json();

    if (!list.length) {
        box.innerHTML = "No products yet.";
        return;
    }

    box.innerHTML = "";

    list.forEach(p=>{
        const row = document.createElement("div");
        row.className = "product-item";

        row.innerHTML = `
            <div style="display:flex;align-items:center;gap:12px;">
                <img src="${p.image}">
                <div>
                    <div style="font-weight:700">${p.name}</div>
                    <div style="font-size:13px;color:#666">${p.description}</div>
                    <div style="font-size:14px;color:#000;margin-top:4px;">₹ ${p.price}</div>
                </div>
            </div>

            <button class="delete-btn" onclick="deleteProduct('${p.id}')">Delete</button>
        `;

        box.appendChild(row);
    });
}

async function deleteProduct(id){
    if(!confirm("Delete this product?")) return;

    await fetch("/products/delete", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ id })
    });

    loadProducts();
    loadDisk();
}

/* --------------------------------------
   DISK USAGE BAR
----------------------------------------*/
async function loadDisk(){
    const r = await fetch("/admin/disk-info", { cache:"no-cache" });
    const j = await r.json();

    document.getElementById("diskFill").style.width = j.usedPct + "%";
    document.getElementById("diskText").textContent =
        `${(j.usedBytes/1024/1024).toFixed(1)} MB used of ${(j.totalBytes/1024/1024/1024).toFixed(1)} GB (${j.usedPct}%)`;
}

/* INIT */
loadProducts();
loadDisk();

</script>

</body>
</html>
