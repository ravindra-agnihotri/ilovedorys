<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Admin Gallery — Dory's Bakehouse</title>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#faebe3;
  --accent:#563e30;
  --card:rgba(253,239,193,0.45);
  --muted:#6d5c54;
}
*{box-sizing:border-box}
body{margin:0;font-family:'Poppins',system-ui;background:var(--bg);color:var(--accent);overflow-x:hidden}
header{width:100%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:1000}
header img.logo{height:60px;border-radius:8px}
header .actions a{background:var(--accent);color:#fff;padding:10px 16px;border-radius:8px;text-decoration:none;margin-left:10px;font-weight:600}

.container{max-width:1200px;margin:22px auto;padding:0 16px}
.title{font-family:'Great Vibes',cursive;font-size:36px;margin:10px 0;text-align:center}

.controls{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:14px}
.controls .btn{background:var(--accent);color:#fff;padding:8px 14px;border-radius:8px;border:none;cursor:pointer}
.controls .btn.ghost{background:transparent;border:1px solid rgba(86,62,48,0.08);color:var(--accent)}

.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:12px}
.card{background:#fff;padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:8px;align-items:center}
.card img{width:100%;height:160px;object-fit:cover;border-radius:8px;cursor:pointer}
.card .meta{width:100%;display:flex;justify-content:space-between;align-items:center;gap:8px}
.card label{display:flex;align-items:center;gap:6px}
.card .trash{background:#e04b4b;color:#fff;padding:6px 8px;border-radius:8px;border:none;cursor:pointer}

/* batch delete bar */
.batchbar{display:flex;justify-content:space-between;align-items:center;padding:10px;background:var(--card);border-radius:10px;margin-bottom:12px}
.batchbar .left{display:flex;gap:12px;align-items:center}
.batchbar .right{display:flex;gap:10px;align-items:center}

/* modal */
.modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);z-index:4000}
.modal .box{background:#fff;padding:18px;border-radius:10px;max-width:90%;max-height:90%;overflow:auto}
.modal img{max-width:100%;max-height:80vh;border-radius:8px}

/* responsive */
@media (max-width:800px){
  .card img{height:140px}
}
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:12px">
    <img class="logo" src="/logo/dorys.PNG" alt="logo">
    <div>
      <div style="font-size:18px;font-weight:700">Dory's Bakehouse</div>
      <div style="font-size:12px;color:var(--muted)">Admin Gallery</div>
    </div>
  </div>
  <div class="actions">
    <a href="/" class="btn ghost">Home</a>
    <a href="/upload.html" class="btn">Upload Images</a>
    <a href="/admin-products.html" class="btn">Products</a>
  </div>
</header>

<div class="container">
  <div class="title">Gallery — Manage Images</div>

  <div class="batchbar">
    <div class="left">
      <label><input type="checkbox" id="selectAll"> Select all</label>
      <div id="countInfo" style="font-size:14px;color:var(--muted)">0 images</div>
    </div>

    <div class="right">
      <button id="deleteSelected" class="btn" style="background:#e04b4b">Delete selected</button>
      <button id="refreshBtn" class="btn ghost" onclick="loadGallery()">Refresh</button>
    </div>
  </div>

  <div id="grid" class="grid">Loading images...</div>

  <div style="margin-top:14px; text-align:center; color:var(--muted); font-size:13px">
    Use checkboxes to select multiple images. Deleting is permanent.
  </div>
</div>

<!-- preview modal -->
<div id="modal" class="modal" aria-hidden="true" onclick="closeModal()">
  <div class="box" onclick="event.stopPropagation()">
    <img id="modalImg" src="" alt="preview">
    <div style="margin-top:8px;text-align:right">
      <button onclick="closeModal()" style="padding:8px 12px;border-radius:8px;border:none;background:#ccc;cursor:pointer">Close</button>
    </div>
  </div>
</div>

<script>
/* admin gate */
function readCookie(name){
  const c = document.cookie.split("; ").find(x=>x.startsWith(name+"="));
  return c ? c.split("=")[1] : null;
}
if(readCookie("admin")!=="4321"){
  const p = prompt("Enter admin PIN:");
  if (p !== "4321") { alert("Wrong PIN"); location.href="/"; }
  document.cookie = "admin=4321; path=/";
}

/* globals */
let images = []; // {file, size, mtime}
const grid = document.getElementById('grid');
const selectAllEl = document.getElementById('selectAll');
const deleteSelectedBtn = document.getElementById('deleteSelected');
const countInfo = document.getElementById('countInfo');

/* load gallery (admin images history) */
async function loadGallery(){
  grid.innerHTML = 'Loading...';
  try {
    const res = await fetch('/images/history', { cache:'no-cache' });
    if (!res.ok) throw new Error('Failed to fetch');
    images = await res.json();
    renderGrid();
  } catch (err) {
    console.error(err);
    grid.innerHTML = '<div style="color:var(--muted)">Could not load images</div>';
  }
}

/* render grid */
function renderGrid(){
  if (!images || images.length === 0) {
    grid.innerHTML = '<div style="color:var(--muted)">No images found</div>';
    countInfo.textContent = '0 images';
    return;
  }

  grid.innerHTML = '';
  countInfo.textContent = images.length + ' images';

  images.forEach((it, idx) => {
    const card = document.createElement('div');
    card.className = 'card';

    // image path relative may include subfolders (products/...)
    const url = '/images/' + encodeURIComponent(it.file);

    // checkbox
    const checkboxId = 'cb-' + idx;
    const checkbox = document.createElement('input');
    checkbox.type = 'checkbox';
    checkbox.dataset.file = it.file;
    checkbox.addEventListener('change', updateSelectedCount);

    // image element
    const img = document.createElement('img');
    img.src = url;
    img.alt = it.file;
    img.loading = 'lazy';
    img.onclick = ()=> openModal(url);

    // meta row
    const meta = document.createElement('div');
    meta.className = 'meta';
    const left = document.createElement('div');
    left.style.display = 'flex'; left.style.alignItems='center'; left.style.gap='8px';
    left.appendChild(checkbox);
    const nameDiv = document.createElement('div');
    nameDiv.style.fontSize='13px'; nameDiv.style.overflow='hidden'; nameDiv.style.textOverflow='ellipsis'; nameDiv.style.maxWidth='160px';
    nameDiv.textContent = it.file;
    left.appendChild(nameDiv);

    const right = document.createElement('div');
    const trash = document.createElement('button');
    trash.className = 'trash';
    trash.textContent = 'Delete';
    trash.addEventListener('click', async ()=>{
      if(!confirm('Delete ' + it.file + ' ?')) return;
      trash.disabled = true; trash.textContent = 'Deleting...';
      await deleteSingle(it.file);
    });
    right.appendChild(trash);

    meta.appendChild(left);
    meta.appendChild(right);

    card.appendChild(img);
    card.appendChild(meta);

    grid.appendChild(card);
  });
}

/* open modal */
function openModal(src){
  document.getElementById('modalImg').src = src;
  document.getElementById('modal').style.display = 'flex';
  document.getElementById('modal').setAttribute('aria-hidden','false');
}
function closeModal(){
  document.getElementById('modal').style.display = 'none';
  document.getElementById('modal').setAttribute('aria-hidden','true');
}

/* update selected count */
function updateSelectedCount(){
  const selected = Array.from(grid.querySelectorAll('input[type=checkbox]')).filter(cb=>cb.checked);
  deleteSelectedBtn.textContent = selected.length ? `Delete selected (${selected.length})` : 'Delete selected';
}

/* select all toggler */
selectAllEl.addEventListener('change', () => {
  const all = grid.querySelectorAll('input[type=checkbox]');
  all.forEach(cb => cb.checked = selectAllEl.checked);
  updateSelectedCount();
});

/* delete selected (batch) */
deleteSelectedBtn.addEventListener('click', async ()=>{
  const selected = Array.from(grid.querySelectorAll('input[type=checkbox]')).filter(cb=>cb.checked).map(cb=>cb.dataset.file);
  if (!selected.length) { alert('No images selected'); return; }
  if (!confirm(`Delete ${selected.length} image(s) permanently?`)) return;

  deleteSelectedBtn.disabled = true; deleteSelectedBtn.textContent = 'Deleting...';

  try {
    const res = await fetch('/images/delete', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ files: selected })
    });
    const j = await res.json();
    // show results
    let msg = '';
    if (j.deleted && j.deleted.length) msg += `Deleted: ${j.deleted.length}\n`;
    if (j.errors && j.errors.length) msg += `Errors: ${j.errors.length}\n`;
    alert(msg || 'Operation completed');
  } catch (err) {
    console.error(err);
    alert('Delete failed');
  } finally {
    deleteSelectedBtn.disabled = false;
    await loadGallery();
  }
});

/* delete single via DELETE endpoint fallback */
async function deleteSingle(filename){
  try {
    const res = await fetch('/images/delete', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ filename })
    });
    const j = await res.json();
    if (j.deleted && j.deleted.length) {
      alert('Deleted: ' + j.deleted[0]);
    } else if (j.errors && j.errors.length) {
      alert('Error deleting: ' + (j.errors.map(e => e.file + ': ' + e.error).join(', ')));
    } else {
      alert('Delete response: ' + JSON.stringify(j));
    }
  } catch (err) {
    console.error(err);
    alert('Delete failed');
  } finally {
    await loadGallery();
  }
}

/* initial */
loadGallery();
</script>

</body>
</html>
