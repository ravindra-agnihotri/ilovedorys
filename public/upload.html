<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Upload Images</title>

<!-- heic2any (browser HEIC -> JPEG converter) -->
<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
<style>
:root{--bg:#FAF0DE;--accent:#563e30;--text:#563e30}
*{box-sizing:border-box}
body{margin:0;font-family:system-ui;background:var(--bg);padding:18px;overflow-x:hidden}
.wrap{max-width:980px;margin:0 auto;background:#fff;padding:18px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
.header{display:flex;align-items:center;justify-content:space-between;gap:12px}
.logo-row{display:flex;align-items:center;gap:12px}
.logo-row img{height:56px;border-radius:8px}
.actions{display:flex;gap:10px;align-items:center}
.admin-link{background:var(--accent);color:#fff;padding:9px 14px;border-radius:8px;text-decoration:none;font-weight:600;cursor:pointer}
.logout{background:#d9534f}
h2{text-align:center;margin-top:14px;color:var(--text)}
.drop{border:2px dashed #e6cfc6;border-radius:10px;padding:28px;text-align:center;color:var(--text);cursor:pointer}
.drop.dragover{background:#fff7f0;border-color:#ff9f85}
input[type=file]{display:none}
.previews{display:flex;flex-wrap:wrap;gap:10px;margin-top:14px}
.previews img{height:80px;width:80px;object-fit:cover;border-radius:8px}
.queue{margin-top:16px}
.queue-item{background:#fff;border:1px solid #f2ded2;padding:10px;border-radius:8px;margin-bottom:10px;display:flex;align-items:center;gap:14px}
.fname{flex:1;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.progress{width:180px;height:8px;background:#eee;border-radius:8px;overflow:hidden}
.progress i{display:block;height:100%;background:var(--accent);width:0%}
.note{font-size:14px;color:#666}
.recent-box div{padding:6px 0;display:flex;justify-content:space-between;align-items:center}
.recent-delete{background:#d9534f;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}
.loading{width:16px;height:16px;border-radius:50%;border:3px solid rgba(86,62,48,0.15);border-top-color:var(--accent);display:inline-block;animation:spin .9s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.small{font-size:13px;color:#777}
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo-row">
      <img src="/logo/dorys.PNG" alt="logo">
      <div>
        <div style="font-weight:700;color:var(--text)">Dory's Bakehouse</div>
        <div style="font-size:13px;color:#666">Image Uploader (Admin)</div>
      </div>
    </div>

    <div class="actions" id="adminMenu" style="display:none;">
      <a class="admin-link" href="/">Home</a>
      <a class="admin-link" href="/upload.html">Upload Images</a>
      <a class="admin-link" href="/admin-products.html">Manage Products</a>
      <button class="admin-link logout" onclick="adminLogout()">Logout</button>
    </div>
  </div>

  <h2>Upload Images — Drag & Drop + Multi File (HEIC → JPG in browser)</h2>

  <div id="drop" class="drop">Click or drag images here to add to upload queue<br/><span class="small">Supports .heic .heif .jpg .jpeg .png .webp</span></div>
  <input id="fileInput" type="file" accept="image/*" multiple>

  <div id="previews" class="previews" aria-live="polite"></div>

  <div style="margin-top:14px;">
    <button id="startUpload" class="admin-link">Start Upload</button>
    <span id="uploadStatus" class="note"></span>
  </div>

  <div id="queue" class="queue"></div>

  <h3 style="margin-top:18px;color:var(--text)">Recent Gallery Images (filenames)</h3>
  <div id="recent" class="recent-box note">Loading...</div>
</div>

<script>
/* ---------------- admin cookie helpers ---------------- */
function readCookie(name){
  const v = document.cookie.split(";").map(x=>x.trim()).find(x=>x.startsWith(name+"="));
  return v ? decodeURIComponent(v.split("=")[1]) : null;
}
function setCookie(name,val,days=7){
  const exp = new Date(Date.now()+days*24*3600*1000).toUTCString();
  document.cookie = `${name}=${encodeURIComponent(val)}; path=/; expires=${exp}`;
}
function deleteCookie(name){ document.cookie = `${name}=; expires=Thu, 01 Jan 1970 00:00:00 GMT; path=/`; }

/* ---------------- admin PIN gate ---------------- */
(function ensurePin(){
  if (readCookie("admin")==="4321"){ document.getElementById("adminMenu").style.display="flex"; return; }
  const pin = prompt("Enter Admin PIN:");
  if (pin === "4321"){ setCookie("admin","4321"); document.getElementById("adminMenu").style.display="flex"; }
  else { alert("Incorrect PIN"); location.href = "/"; }
})();

function adminLogout(){ deleteCookie("admin"); location.href="/"; }

/* ---------------- UI refs ---------------- */
const drop = document.getElementById("drop");
const fileInput = document.getElementById("fileInput");
const previews = document.getElementById("previews");
const queueEl = document.getElementById("queue");
const recentEl = document.getElementById("recent");
const startBtn = document.getElementById("startUpload");
const statusEl = document.getElementById("uploadStatus");

let queue = []; // items: { id, origFile, uploadFile (File/Blob), progEl, statusEl }

/* ---------------- helper: is HEIC ---------------- */
function isHeic(file){
  const name = file.name || "";
  const t = file.type || "";
  return /\.heic$/i.test(name) || /\.heif$/i.test(name) || t === 'image/heic' || t === 'image/heif';
}

/* ---------------- add files & preview (but delay conversion until upload) ---------------- */
function addFiles(files){
  for (const f of Array.from(files)){
    const id = Date.now().toString(36) + Math.random().toString(36).slice(2,6);
    queue.push({ id, origFile: f, uploadFile: null, progEl: null, statusEl: null });

    // preview thumbnail
    const img = document.createElement('img');
    img.src = URL.createObjectURL(f);
    previews.appendChild(img);

    // queue item
    const row = document.createElement('div');
    row.className = 'queue-item';
    row.id = 'q-' + id;
    row.innerHTML = `<div class="fname">${f.name}</div>
                     <div class="progress"><i></i></div>
                     <div class="note" id="st-${id}">Queued</div>`;
    queueEl.appendChild(row);

    const item = queue[queue.length-1];
    item.progEl = row.querySelector('.progress i');
    item.statusEl = document.getElementById('st-' + id);
  }
  updateRecent(); // refresh filenames
}

/* ---------------- drag & drop ---------------- */
drop.addEventListener('click', ()=> fileInput.click());
drop.addEventListener('dragover', (e)=>{ e.preventDefault(); drop.classList.add('dragover'); });
drop.addEventListener('dragleave', ()=> drop.classList.remove('dragover'));
drop.addEventListener('drop', (e)=>{ e.preventDefault(); drop.classList.remove('dragover'); addFiles(e.dataTransfer.files); });
fileInput.addEventListener('change', e => addFiles(e.target.files));

/* ---------------- convert HEIC in browser -> returns File object ----------------
   Uses heic2any (https://github.com/alexgibson/heic2any)
*/
async function convertHeicToJpeg(file){
  if (typeof heic2any === 'undefined') {
    throw new Error('heic2any library not loaded');
  }
  // heic2any accepts Blob
  try {
    const blob = await heic2any({ blob: file, toType: "image/jpeg", quality: 0.92 });
    // blob may be File already or Blob; give it a filename with .jpg
    const fileNameBase = (file.name || 'image').replace(/\.[^/.]+$/, "");
    const jpgFile = new File([blob], fileNameBase + ".jpg", { type: "image/jpeg" });
    return jpgFile;
  } catch (err) {
    console.error('HEIC->JPG conversion failed', err);
    throw err;
  }
}

/* ---------------- prepare uploadFile: convert heic if needed ---------------- */
async function prepareUploadFile(item){
  if (item.uploadFile) return item.uploadFile; // already prepared
  const f = item.origFile;
  if (isHeic(f)) {
    item.statusEl.textContent = 'Converting HEIC...';
    try {
      const converted = await convertHeicToJpeg(f);
      item.uploadFile = converted;
      item.statusEl.textContent = 'Ready (converted)';
    } catch (err) {
      item.statusEl.textContent = 'Convert failed';
      throw err;
    }
  } else {
    // If it's already jpeg/png/webp - use as-is (but ensure correct type)
    item.uploadFile = f;
    item.statusEl.textContent = 'Ready';
  }
  return item.uploadFile;
}

/* ---------------- upload one file with progress (XMLHttpRequest) ---------------- */
function uploadFileWithProgress(item){
  return new Promise(async (resolve, reject) => {
    try {
      await prepareUploadFile(item);
    } catch (err) {
      return reject(err);
    }

    const xhr = new XMLHttpRequest();
    const fd = new FormData();
    fd.append('images', item.uploadFile, item.uploadFile.name || item.origFile.name);

    xhr.open('POST', '/upload', true);
    xhr.withCredentials = true;

    xhr.upload.onprogress = (e) => {
      if (e.lengthComputable) {
        const pct = Math.round((e.loaded / e.total) * 100);
        item.progEl.style.width = pct + '%';
      }
    };

    xhr.onload = function(){
      if (xhr.status >=200 && xhr.status < 300){
        item.progEl.style.width = '100%';
        item.statusEl.textContent = 'Uploaded';
        resolve(JSON.parse(xhr.response || '{}'));
      } else if (xhr.status === 403) {
        alert('Admin auth required. Please re-login.');
        deleteCookie('admin');
        location.reload();
        reject(new Error('auth'));
      } else {
        item.statusEl.textContent = 'Upload failed';
        reject(new Error('Upload error ' + xhr.status));
      }
    };

    xhr.onerror = function(){ item.statusEl.textContent = 'Network error'; reject(new Error('network')); };
    xhr.send(fd);
  });
}

/* ---------------- upload queue (sequential) ---------------- */
startBtn.addEventListener('click', async ()=>{
  if (queue.length === 0){ statusEl.textContent = 'No files in queue'; return; }
  startBtn.disabled = true;
  statusEl.innerHTML = 'Uploading <span class="loading"></span>';

  for (const item of queue){
    item.statusEl.textContent = 'Preparing...';
    try {
      await uploadFileWithProgress(item);
    } catch (err) {
      console.error('upload error', err);
    }
    await new Promise(r=>setTimeout(r, 250));
  }

  statusEl.textContent = 'All done';
  // clear queue & previews after short delay
  setTimeout(()=>{ queue = []; previews.innerHTML = ''; queueEl.innerHTML = ''; updateRecent(); }, 900);
  startBtn.disabled = false;
});

/* ---------------- Recent filenames + delete (admin only) ---------------- */
async function updateRecent(){
  recentEl.textContent = 'Loading...';
  try {
    const res = await fetch('/images/list', { cache: 'no-cache' });
    if (!res.ok) { recentEl.textContent = 'Cannot load list'; return; }
    const arr = await res.json();
    if (!arr || arr.length === 0){ recentEl.textContent = 'No images found.'; return; }

    recentEl.innerHTML = '';
    for (const fname of arr.slice(0,40)){
      const row = document.createElement('div');
      row.style.display='flex';
      row.style.justifyContent='space-between';
      row.style.alignItems='center';
      row.style.gap='12px';
      row.innerHTML = `<div style="flex:1;overflow:hidden;text-overflow:ellipsis">${fname}</div>`;
      const del = document.createElement('button');
      del.textContent = 'Delete';
      del.className = 'recent-delete';
      del.onclick = async ()=>{
        if (!confirm('Delete '+fname+' from gallery?')) return;
        del.disabled = true; del.textContent = 'Deleting...';
        try {
          const r = await fetch('/images/delete', {
            method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ filename: fname })
          });
          const j = await r.json();
          if (r.ok && j.success) updateRecent();
          else { alert('Delete failed: '+(j.error||r.status)); del.disabled=false; del.textContent='Delete'; }
        } catch (err) {
          alert('Delete error'); del.disabled=false; del.textContent='Delete';
        }
      };
      row.appendChild(del);
      recentEl.appendChild(row);
    }
  } catch (err) {
    console.error(err);
    recentEl.textContent = 'Error loading images';
  }
}

/* initial */
updateRecent();
</script>
</body>
</html>
