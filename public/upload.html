<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Dory's Bakehouse — Upload Images</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<!-- HEIC Converter -->
<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

<style>
/* ------------------------------
   GLOBAL THEME (matches index)
--------------------------------*/
:root{
    --bg: #faebe3;
    --accent: #563e30;
    --text: #563e30;
    --card: rgba(253, 239, 193, 0.45);
}

body{
    margin:0;
    padding:0;
    font-family: 'Poppins', system-ui;
    background: var(--bg);
    color: var(--text);
    overflow-x:hidden;
}

/* ------------------------------
   HEADER
--------------------------------*/
header{
    width:100%;
    background:#ffffff;
    box-shadow:0 2px 8px rgba(0,0,0,0.08);
    padding:14px 20px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    position:sticky;
    top:0;
    z-index:1000;
}

header .left{
    display:flex;
    align-items:center;
    gap:14px;
}

header img.logo{
    height:60px;
    width:auto;
}

header h1{
    margin:0;
    font-family:'Great Vibes', cursive;
    font-size:32px;
    color:var(--text);
}

header .actions a{
    margin-left:12px;
    background:var(--accent);
    color:#fff;
    padding:10px 16px;
    border-radius:8px;
    text-decoration:none;
    font-size:14px;
    font-weight:500;
    box-shadow:0 2px 6px rgba(0,0,0,0.15);
}

/* ------------------------------
   MAIN CONTAINER
--------------------------------*/
.container{
    max-width:1100px;
    margin:20px auto 40px;
    padding:0 16px;
}

/* Title */
h2{
    text-align:center;
    font-family:'Great Vibes', cursive;
    font-size:42px;
    margin-top:18px;
    margin-bottom:25px;
    color:var(--text);
}

/* Card */
.card{
    background:var(--card);
    border-radius:14px;
    padding:22px;
    box-shadow:0 6px 22px rgba(0,0,0,0.10);
    margin-bottom:28px;
}

/* ------------------------------
   UPLOADER
--------------------------------*/
.dropzone{
    background:#fff;
    border:2px dashed rgba(86,62,48,0.35);
    border-radius:12px;
    padding:30px;
    min-height:180px;
    text-align:center;
    cursor:pointer;
    transition:0.2s;
}
.dropzone.drag{
    border-color:var(--accent);
    background:rgba(86,62,48,0.08);
}

.dropzone h3{
    margin:0;
    font-size:20px;
    color:var(--accent);
}

.preview-grid{
    margin-top:20px;
    display:grid;
    grid-template-columns:repeat(auto-fill,minmax(120px,1fr));
    gap:14px;
}

.thumb{
    background:#fff;
    border-radius:10px;
    padding:10px;
    text-align:center;
    box-shadow:0 4px 12px rgba(0,0,0,0.08);
}

.thumb img{
    width:100%;
    height:90px;
    object-fit:cover;
    border-radius:8px;
}

.progress{
    margin-top:8px;
    width:100%;
    height:8px;
    background:#eee;
    border-radius:6px;
    overflow:hidden;
}
.progress i{
    display:block;
    height:100%;
    width:0%;
    background:var(--accent);
    transition:width 0.2s;
}

/* ------------------------------
   SIDE PANEL (history + disk)
--------------------------------*/
.side{
    background:#fff;
    border-radius:14px;
    padding:16px;
    box-shadow:0 4px 18px rgba(0,0,0,0.10);
}

.disk-bar{
    width:100%;
    height:10px;
    background:#f0e0c8;
    border-radius:8px;
    overflow:hidden;
}
.disk-bar b{
    display:block;
    height:100%;
    width:0%;
    background:var(--accent);
}

.history{
    max-height:260px;
    overflow-y:auto;
    margin-top:12px;
}

.history-item{
    padding:8px 0;
    border-bottom:1px dashed rgba(0,0,0,0.08);
    font-size:14px;
}

.actions-small{
    margin-top:12px;
}

.actions-small button{
    margin-right:8px;
}

/* -------------------------
   RESPONSIVE
--------------------------*/
@media (max-width:900px){
    .grid{
        grid-template-columns:1fr;
    }
}
</style>
</head>

<body>

<header>
    <div class="left">
        <img src="/logo/dorys.PNG" class="logo">
        <h1>Dory's Bakehouse</h1>
    </div>
    <div class="actions">
        <a href="/">Home</a>
        <a href="/admin-products.html">Manage Products</a>
        <a href="#" id="logoutBtn" style="background:#7b0f0f">Logout</a>
    </div>
</header>

<div class="container">

<h2>Upload Images</h2>

<div class="grid" style="display:grid;grid-template-columns:2fr 1fr;gap:20px;">

    <!-- LEFT: Upload Box -->
    <div class="card">

        <div id="dropzone" class="dropzone">
            <h3>Click or drag images here</h3>
            <p style="color:#777;font-size:14px;margin-top:6px;">
                Supports HEIC, JPG, PNG, WEBP — HEIC auto-converts to JPG
            </p>
            <input id="fileInput" type="file" multiple accept="image/*" style="display:none;">
        </div>

        <div class="actions-small">
            <button id="startBtn" class="btn" style="background:var(--accent);padding:8px 16px;color:white;">Upload</button>
            <button id="clearBtn" class="btn" style="padding:8px 16px;background:#999;color:white;">Clear</button>
            <span id="queueCount" style="margin-left:10px;font-size:14px;color:#555;">0 files</span>
        </div>

        <div id="previewGrid" class="preview-grid"></div>

    </div>

    <!-- RIGHT PANEL -->
    <div class="side">

        <h3 style="margin:0 0 12px 0;font-size:20px;color:var(--text)">Disk Usage</h3>
        <div class="disk-bar"><b id="diskFill"></b></div>
        <div id="diskText" style="margin-top:6px;font-size:14px;color:#555;">Loading...</div>

        <h3 style="margin-top:24px;font-size:20px;color:var(--text)">Recent Uploads</h3>
        <div class="history" id="historyList">
            <div style="color:#777;">Loading...</div>
        </div>

    </div>

</div>

</div> <!-- container end -->



<script>
/* ADMIN PIN CHECK */
function readCookie(n){
  return document.cookie.split("; ").find(x=>x.startsWith(n+"="))?.split("=")[1]||null;
}
function setCookie(n,v){
  document.cookie=n+"="+v+";path=/";
}
function deleteCookie(n){
  document.cookie=n+"=;expires=Thu,01 Jan 1970 00:00:00 GMT;path=/";
}

if(readCookie("admin")!=="4321"){
  let p = prompt("Enter Admin PIN:");
  if(p==="4321") setCookie("admin","4321");
  else { alert("Wrong PIN"); location.href="/"; }
}

document.getElementById("logoutBtn").onclick = ()=>{
    deleteCookie("admin");
    location.href="/";
};

/* ------------------------
   UPLOADER LOGIC
---------------------------*/

const drop = document.getElementById("dropzone");
const input = document.getElementById("fileInput");
const grid = document.getElementById("previewGrid");
const queueCount = document.getElementById("queueCount");

let queue = [];

drop.onclick = ()=> input.click();

drop.ondragover = e => {
    e.preventDefault();
    drop.classList.add("drag");
};
drop.ondragleave = ()=> drop.classList.remove("drag");
drop.ondrop = e =>{
    e.preventDefault();
    drop.classList.remove("drag");
    addFiles(e.dataTransfer.files);
};

input.onchange = e => addFiles(e.target.files);

function isHeic(f){
    return /\.heic$|\.heif$/i.test(f.name);
}

function addFiles(files){
    [...files].forEach(f=>{

        let id = Math.random().toString(36).slice(2);

        let box = document.createElement("div");
        box.className="thumb";
        box.innerHTML = `
            <img src="${URL.createObjectURL(f)}">
            <div style="font-size:13px;color:#444;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">
                ${f.name}
            </div>
            <div class="progress"><i></i></div>
            <div id="st-${id}" style="font-size:12px;color:#666;">Queued</div>
        `;

        grid.appendChild(box);

        queue.push({
            id,
            origFile:f,
            uploadFile:null,
            progEl: box.querySelector("i"),
            statusEl: document.getElementById("st-"+id)
        });
    });

    queueCount.textContent = queue.length+" files";
}

/* HEIC Conversion */
async function convertHeic(file){
    let jpg = await heic2any({ blob:file, toType:"image/jpeg", quality:0.92 });
    return new File([jpg], file.name.replace(/\.\w+$/, ".jpg"), {type:"image/jpeg"});
}

/* Upload Item */
async function uploadItem(item){
    if(!item.uploadFile){
        if(isHeic(item.origFile)){
            item.statusEl.textContent="Converting...";
            item.uploadFile = await convertHeic(item.origFile);
        }else{
            item.uploadFile = item.origFile;
        }
    }

    let fd = new FormData();
    fd.append("images", item.uploadFile);

    return new Promise((resolve,reject)=>{
        let xhr = new XMLHttpRequest();
        xhr.open("POST","/upload");

        xhr.upload.onprogress = e=>{
            if(e.lengthComputable){
                let pct = (e.loaded / e.total)*100;
                item.progEl.style.width = pct+"%";
            }
        };

        xhr.onload = ()=>{
            if(xhr.status===200){
                item.statusEl.textContent="Uploaded";
                resolve();
            }else reject();
        };

        xhr.onerror = reject;
        xhr.send(fd);
    });
}

/* Upload Queue */
document.getElementById("startBtn").onclick = async ()=>{
    for(let item of queue){
        item.statusEl.textContent="Uploading...";
        try{
            await uploadItem(item);
        }catch{
            item.statusEl.textContent="Error";
        }
    }
    queue = [];
    grid.innerHTML="";
    queueCount.textContent="0 files";

    loadDisk();
    loadHistory();
};

document.getElementById("clearBtn").onclick = ()=>{
    queue = [];
    grid.innerHTML="";
    queueCount.textContent="0 files";
};

/* Disk Info */
async function loadDisk(){
    const r = await fetch("/admin/disk-info");
    if(!r.ok) return;
    const d = await r.json();

    document.getElementById("diskFill").style.width = d.usedPct+"%";
    document.getElementById("diskText").textContent =
        (d.usedMB.toFixed(1))+" MB used of "+d.totalGB+" GB";
}

/* History */
async function loadHistory(){
    let r = await fetch("/images/history");
    let box = document.getElementById("historyList");
    if(!r.ok){ box.innerHTML="Error"; return; }

    let arr = await r.json();
    box.innerHTML="";

    arr.slice(0,40).forEach(f=>{
        let div = document.createElement("div");
        div.className="history-item";
        div.textContent = f.file;
        box.appendChild(div);
    });
}

loadDisk();
loadHistory();

</script>

</body>
</html>
