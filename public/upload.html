<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Upload Images</title>

<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap" rel="stylesheet">
<style>
:root{--bg:#FAF0DE;--accent:#563e30;--text:#563e30}
/* styles omitted here for brevity in message; use your existing CSS from previous upload.html */
</style>
</head>
<body>
<div class="wrap">
  <div class="header">
    <div class="logo-row">
      <!-- using uploaded file path as logo per instruction -->
      <img src="logo\dorys.PNG" alt="logo" style="height:56px;border-radius:8px;">
      <div><div style="font-weight:700;color:var(--text)">Dory's Bakehouse</div><div style="font-size:13px;color:#666">Image Uploader (Admin)</div></div>
    </div>

    <div class="actions" id="adminMenu" style="display:none;">
      <a class="admin-link" href="/">Home</a>
      <a class="admin-link" href="/upload.html">Upload Images</a>
      <a class="admin-link" href="/admin-products.html">Manage Products</a>
      <button class="admin-link logout" onclick="adminLogout()">Logout</button>
    </div>
  </div>

  <h2>Upload Images — Drag & Drop + HEIC → JPG</h2>

  <div id="diskInfo" style="margin:12px 0;padding:10px;background:#fff;border-radius:8px;display:flex;align-items:center;gap:12px;">
    <div style="flex:1">
      <div style="font-weight:600">Disk usage</div>
      <div id="diskBar" style="height:12px;background:#eee;border-radius:8px;overflow:hidden;margin-top:6px;">
        <div id="diskFill" style="height:100%;width:0%;background:var(--accent)"></div>
      </div>
      <div style="font-size:13px;color:#666;margin-top:6px;" id="diskText">Loading...</div>
    </div>
    <div style="min-width:160px;text-align:right">
      <div style="font-weight:600">Images</div>
      <div id="imgCount" style="font-size:18px;font-weight:700">—</div>
      <div style="font-size:12px;color:#777">public/images</div>
    </div>
  </div>

  <div id="drop" class="drop">Click or drag images here</div>
  <input id="fileInput" type="file" accept="image/*" multiple>
  <div id="previews" class="previews"></div>
  <div style="margin-top:12px;">
    <button id="startUpload" class="admin-link">Start Upload</button>
    <span id="uploadStatus" class="note"></span>
  </div>

  <div id="queue" class="queue"></div>

  <h3 style="margin-top:18px;color:var(--text)">Upload History (most recent)</h3>
  <div id="history" class="note">Loading...</div>
</div>

<script>
/* same core upload/HEIC-conversion code as before (kept unchanged) */
/* plus new helpers to fetch /admin/disk-info and /images/history */

async function fetchDiskInfo(){
  try{
    const res = await fetch('/admin/disk-info', { cache:'no-cache' });
    if (!res.ok) { document.getElementById('diskText').textContent = 'Disk info unavailable'; return; }
    const j = await res.json();
    const total = j.totalBytes;
    const used = j.usedBytes;
    const pct = j.usedPct;
    document.getElementById('diskFill').style.width = pct + '%';
    document.getElementById('diskText').textContent = `${(used/1024/1024).toFixed(1)} MB used of ${(total/1024/1024/1024).toFixed(1)} GB (${pct}%)`;
    document.getElementById('imgCount').textContent = j.fileCount;
  }catch(e){
    document.getElementById('diskText').textContent = 'Error';
  }
}

async function fetchHistory(){
  const el = document.getElementById('history');
  el.textContent = 'Loading...';
  try {
    const res = await fetch('/images/history', { cache:'no-cache' });
    if (!res.ok) { el.textContent = 'Cannot load history'; return; }
    const arr = await res.json();
    if (!arr || arr.length === 0){ el.textContent = 'No images yet.'; return; }
    // render first 40
    const rows = arr.slice(0,40).map(it => {
      const sizeKb = (it.size/1024).toFixed(1);
      return `<div style="display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid #f0ebe6">
        <div style="flex:1;overflow:hidden;text-overflow:ellipsis">${it.file}</div>
        <div style="width:150px;text-align:right;color:#666">${new Date(it.mtime).toLocaleString()}</div>
        <div style="width:80px;text-align:right;color:#666">${sizeKb} KB</div>
      </div>`;
    }).join('');
    el.innerHTML = rows;
  } catch(e) {
    console.error(e); el.textContent = 'Error loading history';
  }
}

// call these on load and after uploads
fetchDiskInfo();
fetchHistory();

// NOTE: keep your upload queue / heic conversion code from the previous upload.html here.
// For brevity in this message I did not paste the entire upload logic again —
// use the upload code you already had (prepareUploadFile, uploadFileWithProgress, queue flow),
// and call fetchDiskInfo() and fetchHistory() after successful uploads to refresh UI.
</script>
</body>
</html>
