<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin — Manage Products · Dory's Bakehouse</title>

<script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{--bg:#faebe3;--accent:#563e30;--text:#563e30;--muted:#6e5a52;--card:rgba(253,239,193,0.45)}
*{box-sizing:border-box}
body{margin:0;font-family:'Poppins',system-ui;background:var(--bg);color:var(--text)}
header{width:100%;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,0.08);padding:14px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:1000}
.header-left{display:flex;align-items:center;gap:14px}
.logo{height:60px;border-radius:8px}
.btn{background:var(--accent);color:#fff;padding:9px 14px;border-radius:8px;text-decoration:none;border:0;cursor:pointer}
.btn.ghost{background:transparent;color:var(--accent);border:1px solid rgba(86,62,48,0.06)}
.container{max-width:1100px;margin:26px auto;padding:0 16px}
.card{background:var(--card);padding:18px;border-radius:12px;box-shadow:0 8px 26px rgba(0,0,0,0.06)}
.form-row{display:flex;flex-direction:column;gap:8px;margin-bottom:10px}
input[type="text"], input[type="number"], textarea, select{width:100%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:#fff}
.preview{display:flex;gap:12px;align-items:center;margin-top:8px}
.preview img{width:140px;height:110px;object-fit:cover;border-radius:10px}
.products{margin-top:16px;display:flex;flex-direction:column;gap:12px}
.product-item{background:#fff;padding:10px;border-radius:10px;display:flex;gap:12px;align-items:center;box-shadow:0 6px 18px rgba(0,0,0,0.04)}
.product-item img{width:96px;height:76px;object-fit:cover;border-radius:8px}
.product-meta{flex:1;display:flex;flex-direction:column;gap:4px}
.trash{background:#e04b4b;color:#fff;padding:8px 10px;border-radius:8px;border:0;cursor:pointer}
.small-muted{font-size:13px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <img src="/mnt/data/5426C5C3-9890-4592-87F1-D8D068E94052.PNG" class="logo" alt="logo">
    <div>
      <div style="font-family:'Great Vibes';font-size:22px">Dory's Bakehouse</div>
      <div class="small-muted">Admin — Manage Products</div>
    </div>
  </div>
  <div>
    <a class="btn ghost" href="/">Home</a>
    <a class="btn ghost" href="/upload.html">Upload Images</a>
    <a class="btn" href="/admin-gallery.html">Gallery</a>
  </div>
</header>

<div class="container">
  <h2 style="font-family:'Great Vibes';text-align:center;margin:12px 0;color:var(--text)">Manage Products</h2>

  <div style="display:grid;grid-template-columns:1fr 380px;gap:18px">
    <div>
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:700">Add New Product</div>
          <div class="small-muted">Admin PIN required</div>
        </div>

        <form id="productForm">
          <div class="form-row">
            <label class="small-muted">Product Name</label>
            <input id="name" type="text" required placeholder="Chocolate Truffle Cake">
          </div>

          <div class="form-row">
            <label class="small-muted">Description</label>
            <textarea id="description"></textarea>
          </div>

          <div style="display:flex;gap:10px">
            <div style="flex:1" class="form-row">
              <label class="small-muted">Price (₹)</label>
              <input id="price" type="text" placeholder="499">
            </div>
            <div style="width:160px" class="form-row">
              <label class="small-muted">Rating (0-5)</label>
              <input id="rating" type="number" min="0" max="5" step="0.1" placeholder="4.5">
            </div>
          </div>

          <div class="form-row">
            <label class="small-muted">Category</label>
            <select id="category">
              <option value="Cakes">Cakes</option>
              <option value="Designer Cakes">Designer Cakes</option>
              <option value="Cupcakes">Cupcakes</option>
              <option value="Brownies">Brownies</option>
              <option value="Cookies">Cookies</option>
              <option value="Pastries">Pastries</option>
              <option value="Bread & Buns">Bread & Buns</option>
              <option value="Celebration Cakes">Celebration Cakes</option>
              <option value="Anniversaries">Anniversaries</option>
              <option value="Kids Theme Cakes">Kids Theme Cakes</option>
            </select>
          </div>

          <div class="form-row">
            <label class="small-muted">Image</label>
            <input id="prodImage" type="file" accept="image/*">
            <div class="preview" id="imgPreview" style="display:none">
              <img id="previewImg" src="" alt="preview">
              <div>
                <div id="previewName" class="small-muted"></div>
                <div id="previewSize" class="small-muted"></div>
              </div>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:10px">
            <button type="submit" class="btn">Add Product</button>
            <button type="button" class="btn ghost" id="resetBtn">Reset</button>
          </div>

          <div id="formStatus" class="small-muted" style="margin-top:10px"></div>
        </form>
      </div>

      <div class="card" style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">Products</div>
          <div><button class="btn ghost" id="refreshProducts">Refresh</button></div>
        </div>

        <div id="products" class="products">
          <div class="small-muted">Loading products...</div>
        </div>
      </div>

    </div>

    <aside>
      <div class="card">
        <div style="font-weight:700">Disk Usage</div>
        <div style="margin-top:8px" class="small-muted" id="diskText">Loading...</div>
      </div>

      <div class="card" style="margin-top:12px">
        <div style="font-weight:700">Recent Uploads</div>
        <div id="recentList" style="margin-top:8px" class="small-muted">Loading...</div>
      </div>
    </aside>
  </div>
</div>

<script>
/* Admin PIN cookie guard */
function readCookie(n){ return document.cookie.split('; ').find(x=>x.startsWith(n+'='))?.split('=')[1] || null; }
function setCookie(n,v,d=7){ const e = new Date(Date.now()+d*86400000).toUTCString(); document.cookie = `${n}=${v};path=/;expires=${e}`; }
function delCookie(n){ document.cookie = `${n}=;path=/;expires=Thu,01 Jan 1970 00:00:00 GMT`; }

if (readCookie('admin') !== '4321') {
  const p = prompt('Enter admin PIN:');
  if (p === '4321') { setCookie('admin','4321'); } else { alert('Wrong PIN'); location.href = '/'; }
}

/* HEIC conversion helper (uses heic2any) */
function isHeic(f){ return /\.heic$|\.heif$/i.test(f.name) || f.type==='image/heic' || f.type==='image/heif'; }
async function convertHeic(file){ const blob = await heic2any({ blob:file, toType:'image/jpeg', quality:0.92 }); const base = (file.name||'image').replace(/\.[^/.]+$/,''); return new File([blob], base+'.jpg', { type:'image/jpeg' }); }

/* Form logic */
const prodImage = document.getElementById('prodImage');
const previewImg = document.getElementById('previewImg');
const previewName = document.getElementById('previewName');
const previewSize = document.getElementById('previewSize');
const imgPreview = document.getElementById('imgPreview');
let fileToUpload = null;

prodImage.addEventListener('change', async (e) => {
  const f = e.target.files && e.target.files[0];
  if (!f) { imgPreview.style.display='none'; fileToUpload=null; return; }
  previewImg.src = URL.createObjectURL(f);
  previewName.textContent = f.name;
  previewSize.textContent = (f.size/1024).toFixed(1) + ' KB';
  imgPreview.style.display='flex';
  if (isHeic(f)) {
    try { fileToUpload = await convertHeic(f); previewName.textContent = fileToUpload.name; previewSize.textContent = (fileToUpload.size/1024).toFixed(1)+' KB'; previewImg.src = URL.createObjectURL(fileToUpload); }
    catch(e){ console.error(e); alert('HEIC convert failed. Please convert locally.'); fileToUpload=null; }
  } else { fileToUpload = f; }
});

/* Submit product */
document.getElementById('productForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  const name = document.getElementById('name').value.trim();
  const description = document.getElementById('description').value.trim();
  const price = document.getElementById('price').value.trim();
  const category = document.getElementById('category').value;
  const rating = document.getElementById('rating').value;

  if (!name) { alert('Name required'); return; }

  const fd = new FormData();
  fd.append('name', name);
  fd.append('description', description);
  fd.append('price', price);
  fd.append('category', category);
  fd.append('rating', rating);

  if (fileToUpload) fd.append('image', fileToUpload, fileToUpload.name);

  const statusEl = document.getElementById('formStatus'); statusEl.textContent = 'Uploading...';
  try {
    const r = await fetch('/products/add', { method:'POST', body: fd, credentials: 'include' });
    const j = await r.json();
    if (r.ok) { statusEl.textContent = 'Product added'; document.getElementById('productForm').reset(); imgPreview.style.display='none'; fileToUpload=null; loadProducts(); loadRecent(); }
    else { statusEl.textContent = 'Error: ' + (j.error || 'Failed'); }
  } catch (err) { console.error(err); statusEl.textContent = 'Network error'; }
});

/* Reset */
document.getElementById('resetBtn').addEventListener('click', ()=> { document.getElementById('productForm').reset(); imgPreview.style.display='none'; fileToUpload=null; });

/* Load products */
async function loadProducts(){
  const container = document.getElementById('products'); container.innerHTML='Loading...';
  try {
    const res = await fetch('/products/list', { cache:'no-cache' });
    const arr = await res.json();
    if (!arr.length) { container.innerHTML = '<div class="small-muted">No products yet</div>'; return; }
    container.innerHTML = '';
    arr.forEach(p => {
      const el = document.createElement('div'); el.className='product-item';
      el.innerHTML = `<img src="${p.image}" alt="${p.name}">
        <div class="product-meta">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${p.name}</div>
            <div style="font-weight:700">₹ ${p.price || '-'}</div>
          </div>
          <div class="small-muted">${p.description || ''}</div>
          <div style="margin-top:6px;font-size:13px;color:var(--muted)">Category: ${p.category || 'Uncategorized'} · Rating: ${Number(p.rating || 0).toFixed(1)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="trash" data-id="${p.id}">Delete</button>
        </div>`;
      container.appendChild(el);
    });
    // attach delete handlers
    container.querySelectorAll('.trash').forEach(btn => {
      btn.addEventListener('click', async () => {
        if (!confirm('Delete product?')) return;
        btn.disabled = true; btn.textContent = 'Deleting...';
        const id = btn.dataset.id;
        try {
          const r = await fetch('/products/delete', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ id }) });
          const j = await r.json();
          if (r.ok) loadProducts(); else { alert('Delete error: ' + (j.error||r.status)); btn.disabled=false; btn.textContent='Delete'; }
        } catch (err) { console.error(err); alert('Delete failed'); btn.disabled=false; btn.textContent='Delete'; }
      });
    });
  } catch (err) { console.error(err); container.innerHTML='<div class="small-muted">Could not load products</div>'; }
}

/* refresh */
document.getElementById('refreshProducts').addEventListener('click', loadProducts);

/* disk & recent */
async function loadRecent(){
  try {
    const r = await fetch('/images/history', { cache:'no-cache' });
    if (!r.ok) return;
    const arr = await r.json();
    const list = arr.slice(0,8);
    const out = list.map(x => `<div style="padding:6px 0;display:flex;justify-content:space-between"><div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${x.file}</div><div style="color:var(--muted);font-size:12px">${new Date(x.mtime).toLocaleString()}</div></div>`).join('');
    document.getElementById('recentList').innerHTML = out;
  } catch (err) { console.error(err); document.getElementById('recentList').innerHTML = '<div class="small-muted">N/A</div>'; }
}
async function refreshDisk(){ try { const r = await fetch('/admin/disk-info', { cache:'no-cache' }); if (!r.ok) return; const j = await r.json(); document.getElementById('diskText').textContent = `${(j.usedMB||0).toFixed(1)} MB used of ${j.totalGB||5} GB (${j.usedPct||0}%)`; } catch(e){ console.error(e); } }

loadProducts(); loadRecent(); refreshDisk(); setInterval(refreshDisk, 60*1000);
</script>
</body>
</html>
