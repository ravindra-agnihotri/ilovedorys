<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Our Products ‚Äî Dory's Bakehouse</title>

<link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

<style>
:root{
  /* MATCH INDEX PAGE BACKGROUND */
  --bg: rgba(255, 243, 207, 0.45);
  --accent:#563e30;
  --text:#563e30;
  --muted:#6e5a52;
  --card: rgba(253,239,193,0.45);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:'Poppins',system-ui;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
header{
  width:100%;
  background:#fff;
  box-shadow:0 2px 8px rgba(0,0,0,0.08);
  padding:12px 20px;
  display:flex;
  align-items:center;
  justify-content:center;
  position:sticky;
  top:0;
  z-index:1000;
}
.header-left{position:absolute;left:18px;display:flex;align-items:center;gap:12px}
.home-btn{
  background:var(--accent);
  color:#fff;
  padding:8px 12px;
  border-radius:10px;
  text-decoration:none;
  font-weight:600;
  box-shadow:0 3px 8px rgba(0,0,0,0.12);
}
.logo-img{height:64px;width:auto;border-radius:8px}
.header-actions{position:absolute;right:28px}
.contact-btn{
  background:var(--accent);
  color:#fff;
  padding:10px 14px;
  border-radius:8px;
  text-decoration:none;
  font-weight:600;
  box-shadow:0 2px 6px rgba(0,0,0,0.12);
  cursor:pointer;
}

/* filter centered under header */
.filter-bar{
  max-width:1100px;margin:18px auto 6px;padding:0 16px;display:flex;justify-content:center;gap:10px;align-items:center;
}
.filter-btn{
  background:#fff;border:1px solid rgba(86,62,48,0.08);padding:8px 14px;border-radius:999px;cursor:pointer;font-weight:600;color:var(--accent);
  box-shadow:0 6px 18px rgba(0,0,0,0.03);
}
.filter-btn.active{background:var(--accent);color:#fff;box-shadow:0 8px 26px rgba(86,62,48,0.12)}

/* search & sort */
.search-bar{max-width:1100px;margin:6px auto;display:flex;gap:8px;justify-content:center;padding:0 16px}
.search-bar input{width:60%;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.search-bar select{padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}

/* page title */
.title{font-family:'Great Vibes',cursive;text-align:center;font-size:36px;margin:10px 0;color:var(--text)}

/* container & grid */
.container{max-width:1200px;margin:12px auto;padding:0 16px}
.products-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:18px;margin-top:14px}
@media(max-width:880px){ .products-grid{grid-template-columns:repeat(auto-fill,minmax(200px,1fr))} }

/* product card (clean, no rating, no add-to-cart) */
.card{
  background:var(--card);
  padding:12px;border-radius:12px;box-shadow:0 8px 28px rgba(0,0,0,0.06);display:flex;flex-direction:column;gap:10px;position:relative;overflow:visible;
}
.img-wrap{width:100%;height:180px;border-radius:10px;overflow:hidden;background:#fff;display:flex;align-items:center;justify-content:center}
.card img{width:100%;height:100%;object-fit:cover}
.meta{display:flex;justify-content:space-between;align-items:center;gap:8px}
.name{font-weight:700;font-size:18px}
.cat{font-size:13px;color:var(--muted);background:rgba(86,62,48,0.06);padding:6px 10px;border-radius:999px}
.price{font-weight:700;color:var(--accent)}
.desc{font-size:14px;color:#5e4e46;min-height:36px}

/* Enquire overlay (visible on hover or tap) */
.enquire-overlay{
  position:absolute;left:12px;right:12px;bottom:14px;padding:10px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.95),rgba(250,235,227,0.95));display:flex;justify-content:center;align-items:center;opacity:0;transform:translateY(8px);transition:all .18s;
  pointer-events:none;
}
.card:hover .enquire-overlay, .card.enquire-active .enquire-overlay{ opacity:1; transform:translateY(0); pointer-events:auto; }
.enquire-btn{
  background:var(--accent);color:#fff;padding:8px 12px;border-radius:999px;border:0;cursor:pointer;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.12)
}

/* mini popup above card */
.enquire-popup{
  position:absolute; left:50%; transform:translateX(-50%); bottom:calc(100% + 12px); z-index:500; width:280px; max-width:calc(100% - 24px);
  background:#fff;border-radius:10px;padding:10px;box-shadow:0 12px 36px rgba(0,0,0,0.25); display:none;
}
.enquire-popup.active{ display:block; }
.enquire-popup .thumb{height:72px;width:72px;object-fit:cover;border-radius:8px}
.enquire-popup textarea{width:100%;min-height:70px;padding:8px;border-radius:8px;border:1px solid #eee}

/* floating buttons */
.floating {
  position:fixed; right:18px; bottom:18px; display:flex;flex-direction:column;gap:12px; z-index:4000;
}
.btn-circle{width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 8px 24px rgba(0,0,0,0.18);cursor:pointer;border:0}
.whatsapp{background:#25D366}
.chat{background:#ff7f7f}
.floating img{width:28px;height:28px}

/* Manage products floating (bottom-left) */
.manage-floating{
  position:fixed; left:18px; bottom:18px; z-index:4000;
}
.manage-floating .manage-btn{
  background:var(--accent);color:#fff;padding:12px 16px;border-radius:10px;border:0;cursor:pointer;font-weight:700;box-shadow:0 8px 24px rgba(0,0,0,0.18)
}

/* contact popup (same as index) */
.popup-overlay{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,0.45);z-index:3000;padding:20px;box-sizing:border-box}
.popup-box{background:#faebe3;padding:22px;border-radius:14px;max-width:420px;width:100%;text-align:center;box-shadow:0 8px 34px rgba(0,0,0,0.18)}
.popup-box h3{margin:0;font-size:20px;color:var(--accent)}
.popup-box p{margin:10px 0;color:#444;font-weight:600}
.close-btn{margin-top:12px;background:var(--accent);color:#fff;padding:10px 18px;border-radius:8px;cursor:pointer}

/* small text helper */
.small-muted{font-size:13px;color:var(--muted)}
</style>
</head>
<body>

<header>
  <div class="header-left">
    <a class="home-btn" href="/">Home</a>
  </div>

  <!-- logo centered (user selected path) -->
  <img src="/logo/dorys.PNG" class="logo-img" alt="Dory's Bakehouse">

  <div class="header-actions">
    <a class="contact-btn" id="openContact">Contact</a>
  </div>
</header>

<!-- filters -->
<div class="filter-bar" role="tablist" aria-label="category filters">
  <button class="filter-btn active" data-cat="All">All</button>
  <button class="filter-btn" data-cat="Cakes">Cakes</button>
  <button class="filter-btn" data-cat="Cupcakes">Cupcakes</button>
  <button class="filter-btn" data-cat="Pastries">Pastries</button>
</div>

<!-- search & sort -->
<div class="search-bar">
  <input id="searchInput" type="search" placeholder="Search products by name...">
  <select id="sortSelect">
    <option value="newest">Newest</option>
    <option value="price-asc">Price: Low ‚Üí High</option>
    <option value="price-desc">Price: High ‚Üí Low</option>
  </select>
</div>

<div class="title">Our Products</div>

<div class="container">
  <div id="countInfo" class="small-muted" style="text-align:center;margin-bottom:8px">Loading products...</div>
  <div id="grid" class="products-grid" aria-live="polite">Loading...</div>
</div>

<!-- Floating WhatsApp & Chat -->
<div class="floating" aria-hidden="false">
  <button class="btn-circle chat" id="chatBtn" title="Chat with us" aria-label="Chat">
    <img src="https://cdn-icons-png.flaticon.com/512/2462/2462719.png" alt="chat">
  </button>

  <a class="btn-circle whatsapp" id="waBtn" title="WhatsApp" target="_blank" rel="noreferrer" aria-label="WhatsApp">
    <img src="https://upload.wikimedia.org/wikipedia/commons/6/6b/WhatsApp.svg" alt="whatsapp">
  </a>
</div>

<!-- Manage Products floating (bottom-left) - visible only for admin cookie -->
<div class="manage-floating" id="manageFloating" style="display:none">
  <button class="manage-btn" id="manageBtn">Manage Products</button>
</div>

<!-- Contact popup identical to index -->
<div id="contactPopup" class="popup-overlay" aria-hidden="true">
  <div class="popup-box" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
    <h3 id="contactTitle">Contact Us</h3>
    <p>üìû <a id="telLink" href="tel:+919168445014" style="color:var(--accent);text-decoration:none;font-weight:700">+91 9168445014</a></p>
    <p>üìç Dory's Bakehouse, Pune</p>
    <button class="close-btn" id="closeContact">Close</button>
  </div>
</div>

<script>
/* Configuration */
const WA_NUMBER = '919168445014'; // country code + number
const WA_BASE = `https://wa.me/${WA_NUMBER}`;
const WA_DEFAULT_TEXT = encodeURIComponent('Hi, I want to order');
const WA_URL_DEFAULT = `${WA_BASE}?text=${WA_DEFAULT_TEXT}`;

/* Admin visibility: show manage button only when admin cookie present */
function readCookie(name){
  const c = document.cookie.split('; ').find(x => x.trim().startsWith(name + '='));
  return c ? decodeURIComponent(c.split('=')[1]) : null;
}
if (readCookie('admin') === '4321') {
  document.getElementById('manageFloating').style.display = 'block';
}

/* OPEN / CLOSE Contact popup */
const contactPopup = document.getElementById('contactPopup');
document.getElementById('openContact').addEventListener('click', ()=> {
  contactPopup.style.display = 'flex';
  contactPopup.setAttribute('aria-hidden','false');
});
document.getElementById('closeContact').addEventListener('click', ()=> {
  contactPopup.style.display = 'none';
  contactPopup.setAttribute('aria-hidden','true');
});
contactPopup.addEventListener('click', (e)=> { if (e.target === contactPopup) { contactPopup.style.display='none'; contactPopup.setAttribute('aria-hidden','true'); } });

/* Floating buttons */
document.getElementById('waBtn').href = WA_URL_DEFAULT;
document.getElementById('chatBtn').addEventListener('click', ()=> { window.open(WA_URL_DEFAULT, '_blank'); });

/* Manage button click */
document.getElementById('manageBtn').addEventListener('click', ()=> { location.href = '/admin-products.html'; });

/* Products loading/rendering/search/sort/filter */
const grid = document.getElementById('grid');
const countInfo = document.getElementById('countInfo');
let products = [];
let activeCategory = 'All';

async function loadProducts(){
  try {
    const res = await fetch('/products/list', { cache: 'no-cache' });
    if (!res.ok) throw new Error('Failed to fetch products');
    products = await res.json();
  } catch (err) {
    console.error(err);
    products = [];
  }
  render();
}

function sortProducts(arr){
  const mode = document.getElementById('sortSelect').value;
  const copy = arr.slice();
  if (mode === 'price-asc') copy.sort((a,b)=> (Number(a.price)||0) - (Number(b.price)||0));
  else if (mode === 'price-desc') copy.sort((a,b)=> (Number(b.price)||0) - (Number(a.price)||0));
  else copy.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));
  return copy;
}

function render(){
  const q = document.getElementById('searchInput').value.trim().toLowerCase();
  const filtered = products.filter(p => 
    (activeCategory === 'All' || (p.category || '').toLowerCase() === activeCategory.toLowerCase()) &&
    (p.name || '').toLowerCase().includes(q)
  );
  const sorted = sortProducts(filtered);
  grid.innerHTML = '';
  countInfo.textContent = `${sorted.length} product${sorted.length===1?'':'s'} shown`;

  if (!sorted.length) {
    grid.innerHTML = `<div style="grid-column:1/-1;text-align:center;color:var(--muted);padding:40px">No products found.</div>`;
    return;
  }

  sorted.forEach(p => {
    const name = p.name || 'Untitled';
    const desc = p.description || '';
    const price = p.price ? `‚Çπ ${p.price}` : '‚Äî';
    const category = p.category || 'Uncategorized';
    const img = (p.image && p.image.startsWith('/')) ? p.image : (p.image || '/images/products/default-sample.png');

    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div class="img-wrap"><img src="${img}" alt="${escapeHtml(name)}" loading="lazy"></div>
      <div class="meta">
        <div>
          <div class="name">${escapeHtml(name)}</div>
          <div class="desc">${escapeHtml(desc)}</div>
        </div>
        <div style="text-align:right">
          <div class="cat">${escapeHtml(category)}</div>
          <div style="margin-top:6px" class="price">${escapeHtml(price)}</div>
        </div>
      </div>

      <div class="enquire-overlay">
        <button class="enquire-btn">Enquire Now</button>
      </div>

      <div class="enquire-popup" role="dialog" aria-hidden="true">
        <div style="display:flex;gap:8px;align-items:center">
          <img class="thumb" src="${img}" alt="${escapeHtml(name)}">
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(name)}</div>
            <div style="color:var(--muted);font-size:13px">${escapeHtml(category)} ¬∑ ${escapeHtml(price)}</div>
          </div>
        </div>
        <div style="margin-top:8px">
          <textarea class="enquire-text" placeholder="Your message (e.g., I want 1 kg, delivery date...)"></textarea>
        </div>
        <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
          <button class="enquire-send" style="background:var(--accent);color:#fff;padding:8px 12px;border-radius:8px;border:0;cursor:pointer">Send on WhatsApp</button>
          <button class="enquire-cancel" style="background:#ccc;color:#222;padding:8px 12px;border-radius:8px;border:0;cursor:pointer">Cancel</button>
        </div>
      </div>
    `;

    // Enquire interactions
    const enquireBtn = card.querySelector('.enquire-btn');
    const enquirePopup = card.querySelector('.enquire-popup');
    const enquireSend = card.querySelector('.enquire-send');
    const enquireCancel = card.querySelector('.enquire-cancel');
    const enquireText = card.querySelector('.enquire-text');

    enquireBtn.addEventListener('click', (ev) => {
      ev.stopPropagation();
      closeAllEnquires();
      enquirePopup.classList.add('active');
      enquirePopup.setAttribute('aria-hidden','false');
      card.classList.add('enquire-active');
      // focus textarea on open for convenience
      setTimeout(()=> enquireText.focus(), 120);
    });

    enquireCancel.addEventListener('click', (ev) => {
      ev.stopPropagation();
      enquirePopup.classList.remove('active');
      enquirePopup.setAttribute('aria-hidden','true');
      card.classList.remove('enquire-active');
    });

    enquireSend.addEventListener('click', (ev) => {
      ev.stopPropagation();
      const userMsg = (enquireText.value || '').trim();
      let message = `Product Enquiry:%0AName: ${name}%0ACategory: ${category}%0APrice: ${price}%0A`;
      if (userMsg) message += `%0AUser Message:%0A${encodeURIComponent(userMsg)}`;
      // open WhatsApp with prefilled message
      window.open(`${WA_BASE}?text=${message}`, '_blank');
      enquirePopup.classList.remove('active');
      enquirePopup.setAttribute('aria-hidden','true');
      card.classList.remove('enquire-active');
      enquireText.value = '';
    });

    // close enquiry when clicking outside card
    document.addEventListener('click', (e) => {
      if (!card.contains(e.target)) {
        enquirePopup.classList.remove('active');
        enquirePopup.setAttribute('aria-hidden','true');
        card.classList.remove('enquire-active');
      }
    });

    grid.appendChild(card);
  });
}

/* Helpers */
function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function closeAllEnquires(){
  document.querySelectorAll('.enquire-popup.active').forEach(p => { p.classList.remove('active'); p.setAttribute('aria-hidden','true'); });
  document.querySelectorAll('.card.enquire-active').forEach(c => c.classList.remove('enquire-active'));
}

/* Filters & events */
document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', () => {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  activeCategory = btn.getAttribute('data-cat') || 'All';
  render();
}));
document.getElementById('searchInput').addEventListener('input', ()=> render());
document.getElementById('sortSelect').addEventListener('change', ()=> render());

/* Initial load + auto refresh */
loadProducts();
setInterval(loadProducts, 90000);
</script>
</body>
</html>
